<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relief Fund AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .chat-bubble-bot {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #4b5563; /* gray-600 */
            }
            50%, 100% {
                background-color: #d1d5db; /* gray-300 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div class="w-full max-w-2xl h-[90vh] flex flex-col bg-white rounded-2xl shadow-2xl">

        <!-- Chat Container -->
        <div id="chat-container" class="w-full h-full flex flex-col bg-white rounded-2xl">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 rounded-t-2xl bg-white sticky top-0">
                <h1 class="text-2xl font-bold text-gray-800 text-center">Relief Fund AI Assistant</h1>
                <p class="text-sm text-gray-500 text-center">Ask me about the Dragon Sphere and Saiyan Resilience funds</p>
            </div>

            <!-- Chat Window -->
            <div id="chat-window" class="flex-1 p-6 overflow-y-auto">
                <!-- Messages will be injected here -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden p-6 pt-0">
                <div class="flex items-start gap-3 my-4">
                     <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-200 flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 O 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div class="chat-bubble-bot p-4 rounded-lg max-w-lg">
                        <div class="dot-flashing"></div>
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <form id="chat-form" class="flex items-center space-x-3">
                    <input type="text" id="chat-input" placeholder="Type your question here..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button type="submit" class="bg-blue-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- CONFIGURATION ---
        // Replace this URL with the HTTP Post URL from your Power Automate Flow trigger.
        const secureProxyUrl = "https://3188d7cb099be52a8b2458be818936.1e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/90b46ffc91844562bc81a1e9e2a9a666/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FpLylmsJkRJaIHdCI5xhChaqOJj46SluPiIBTYZmRME"; 
        
        // App State
        let conversationHistory = [];

        // The knowledge base now includes a strict system prompt to control the AI's behavior.
        // It will be sent to the backend with every request.
        const knowledgeBase = `
        --- SYSTEM PROMPT: FOLLOW THESE RULES ---
        1. You are a helpful AI assistant for employees with questions about the two relief funds described below.
        2. Your knowledge is STRICTLY and ONLY limited to the information contained within "DOCUMENT 1" and "DOCUMENT 2".
        3. Under no circumstances should you use any external information or prior knowledge to answer a question.
        4. If a user asks a question that cannot be answered from the text of the documents, you MUST respond with the exact phrase: "I'm sorry, I don't have information on that topic. Please refer to the official program documentation for more details."
        5. Do not answer questions about any other topic, including math, history, or general knowledge. If the question is not about the relief funds, use the phrase from rule #4.
        --- END OF RULES ---

        DOCUMENT 1: Dragon Sphere Humanitarian Aid Fund
        ---
        The Dragon Sphere Humanitarian Aid Fund assists employees impacted by complex emergencies, humanitarian crises, and intergalactic conflicts. Drawing inspiration from the mystical Dragon Balls, this fund grants 'wishes' of relief to restore balance and hope.
        Program Parameters:
        - Eligible Countries: Earth (all continents), Namek, New Planet Vegeta, Galactic Patrol Bases
        - Employment Type: Full-time, Part-time, Seasonal Fighters, Tournament of Power Contractors
        - Event Types: Floods, Volcanic Eruptions, Intergalactic Wars, Frieza Force Attacks
        - Eligibility Categories: Complex Humanitarian Emergencies, Housing Loss, Wellbeing & Trauma Recovery, Loss due to Alien Conflict

        DOCUMENT 2: Saiyan Resilience Relief Fund
        ---
        The Saiyan Resilience Relief Fund supports employees and families affected by natural disasters and personal hardships. Inspired by the perseverance of Saiyan warriors, this fund provides financial and mental health support to those in need.
        Program Parameters:
        - Eligible Countries: Earth (North America, Europe, Asia), Namek, Planet Vegeta Survivors (diaspora)
        - Employment Type: Full-time, Part-time, Contract (minimum 6 months), Capsule Corp Internships
        - Event Types: Earthquakes, Hurricanes, Saiyan Invasions, Ki Blast Collateral Damage
        - Eligibility Categories: Medical Emergencies, Mental Health & Wellbeing, Natural Disasters, Family Hardships
        `;

        // Function to start the chat application
        function startChat() {
            const welcomeMessage = "Hello! I'm here to help you with questions about the Dragon Sphere and Saiyan Resilience employee relief funds. How can I assist you today?";
            addMessage('bot', welcomeMessage);
            // We don't store the welcome message in history, as the backend will manage the full context.
        }

        // Function to call the SECURE PROXY (Power Automate Flow or Azure Function)
        async function getAIResponse(userQuery) {
            if (secureProxyUrl === "YOUR_POWER_AUTOMATE_OR_AZURE_FUNCTION_URL_HERE") {
                return "The secure proxy URL is not configured. Please update the 'secureProxyUrl' variable in the script.";
            }

            // The payload now includes the knowledgeBase from this file.
            // The backend (your Flow) will receive this and use it in its call to the Gemini API.
            const payload = {
                knowledgeBase: knowledgeBase,
                history: conversationHistory,
                query: userQuery
            };

            try {
                const response = await fetch(secureProxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Proxy Error:", errorText);
                    return `There was an error communicating with the server: ${response.statusText}`;
                }

                // We now expect the proxy to return the direct JSON response from Gemini.
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure from proxy:", result);
                    return "I received an unusual response from the server. Please try again.";
                }

            } catch (error) {
                console.error('Error fetching AI response via proxy:', error);
                return "I'm having trouble connecting to the server right now. Please check your connection or try again later.";
            }
        }

        // Function to add a message to the chat window
        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex items-start gap-3 my-4 ${sender === 'user' ? 'justify-end' : ''}`;
            
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const formattedMessage = sanitizedMessage.replace(/\n/g, '<br>');

            let bubbleContent = '';
            if (sender === 'bot') {
                bubbleContent = `
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-200 flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div class="chat-bubble-bot p-4 rounded-lg max-w-lg">
                        ${formattedMessage}
                    </div>
                `;
            } else {
                 bubbleContent = `
                    <div class="chat-bubble-user p-4 rounded-lg max-w-lg">
                        ${formattedMessage}
                    </div>
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-500 text-white flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                 `;
            }

            messageElement.innerHTML = bubbleContent;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Handle Chat Form Submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (userInput === '') return;

            addMessage('user', userInput);
            chatInput.value = '';
            loadingIndicator.classList.remove('hidden');

            // Add user message to history
            conversationHistory.push({ role: "user", parts: [{ text: userInput }] });

            const aiResponse = await getAIResponse(userInput);

            // Add model response to history
            conversationHistory.push({ role: "model", parts: [{ text: aiResponse }] });
            
            // Limit history to last 10 messages (5 pairs) to keep payload small
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }

            loadingIndicator.classList.add('hidden');
            addMessage('bot', aiResponse);
        });
        
        // Initializer
        window.onload = () => {
            startChat();
        };

    </script>
</body>
</html>


