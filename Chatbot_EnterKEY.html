<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relief Fund AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .chat-bubble-bot {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4b5563; /* gray-600 */
            color: #4b5563; /* gray-600 */
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #4b5563; /* gray-600 */
            }
            50%, 100% {
                background-color: #d1d5db; /* gray-300 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div class="w-full max-w-2xl h-[90vh] flex flex-col bg-white rounded-2xl shadow-2xl">

        <!-- API Key Input Section -->
        <div id="api-key-section" class="flex flex-col items-center justify-center h-full p-8">
            <h1 class="text-2xl font-bold text-gray-800 text-center mb-2">Welcome!</h1>
            <p class="text-gray-600 text-center mb-6">Please enter your Gemini API key to start the chat.</p>
            <form id="api-key-form" class="w-full max-w-md">
                <input type="password" id="api-key-input" placeholder="Enter your Gemini API Key" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                    Start Chat
                </button>
            </form>
             <p class="text-xs text-gray-400 mt-4 text-center">Your API key is stored only in your browser for this session.</p>
        </div>


        <!-- Chat Container -->
        <div id="chat-container" class="w-full h-full flex-col bg-white rounded-2xl hidden">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 rounded-t-2xl bg-white sticky top-0">
                <h1 class="text-2xl font-bold text-gray-800 text-center">Relief Fund AI Assistant</h1>
                <p class="text-sm text-gray-500 text-center">Ask me about the Dragon Sphere and Saiyan Resilience funds</p>
            </div>

            <!-- Chat Window -->
            <div id="chat-window" class="flex-1 p-6 overflow-y-auto">
                <!-- Messages will be injected here -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden p-6 pt-0">
                <div class="flex items-start gap-3 my-4">
                     <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-200 flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div class="chat-bubble-bot p-4 rounded-lg max-w-lg">
                        <div class="dot-flashing"></div>
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <form id="chat-form" class="flex items-center space-x-3">
                    <input type="text" id="chat-input" placeholder="Type your question here..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button type="submit" class="bg-blue-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const apiKeySection = document.getElementById('api-key-section');
        const apiKeyForm = document.getElementById('api-key-form');
        const apiKeyInput = document.getElementById('api-key-input');
        const chatContainer = document.getElementById('chat-container');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loadingIndicator = document.getElementById('loading-indicator');

        // App State
        let geminiApiKey = sessionStorage.getItem('geminiApiKey');
        let conversationHistory = [];

        // This is the knowledge base extracted from your uploaded documents.
        const knowledgeBase = `
        DOCUMENT 1: Dragon Sphere Humanitarian Aid Fund
        ---
        The Dragon Sphere Humanitarian Aid Fund assists employees impacted by complex emergencies, humanitarian crises, and intergalactic conflicts. Drawing inspiration from the mystical Dragon Balls, this fund grants 'wishes' of relief to restore balance and hope.
        Program Parameters:
        - Eligible Countries: Earth (all continents), Namek, New Planet Vegeta, Galactic Patrol Bases
        - Employment Type: Full-time, Part-time, Seasonal Fighters, Tournament of Power Contractors
        - Event Types: Floods, Volcanic Eruptions, Intergalactic Wars, Frieza Force Attacks
        - Eligibility Categories: Complex Humanitarian Emergencies, Housing Loss, Wellbeing & Trauma Recovery, Loss due to Alien Conflict

        DOCUMENT 2: Saiyan Resilience Relief Fund
        ---
        The Saiyan Resilience Relief Fund supports employees and families affected by natural disasters and personal hardships. Inspired by the perseverance of Saiyan warriors, this fund provides financial and mental health support to those in need.
        Program Parameters:
        - Eligible Countries: Earth (North America, Europe, Asia), Namek, Planet Vegeta Survivors (diaspora)
        - Employment Type: Full-time, Part-time, Contract (minimum 6 months), Capsule Corp Internships
        - Event Types: Earthquakes, Hurricanes, Saiyan Invasions, Ki Blast Collateral Damage
        - Eligibility Categories: Medical Emergencies, Mental Health & Wellbeing, Natural Disasters, Family Hardships
        `;

        // The system prompt that guides the AI's behavior.
        const systemPrompt = `You are a helpful and friendly AI assistant for employees. Your role is to answer questions about two specific employee relief funds: the "Dragon Sphere Humanitarian Aid Fund" and the "Saiyan Resilience Relief Fund".

        Your knowledge is strictly limited to the information provided in the two documents below. Do not use any external knowledge or make up information. If a question cannot be answered from the provided text, you must say, "I'm sorry, but I don't have information on that topic. Please refer to official program documentation."

        When answering, be clear and concise. If the user's question is about a specific fund, focus your answer on that fund. Provide bulleted lists when possible for the funds eligiblity criteria. If the question is general, you may compare or mention both funds if relevant. Start your first message with a friendly greeting.
        `;

        // Function to start the chat application
        function startChat() {
            apiKeySection.classList.add('hidden');
            chatContainer.style.display = 'flex'; // Use flex to match original layout
            const welcomeMessage = "Hello! I'm here to help you with questions about the Dragon Sphere and Saiyan Resilience employee relief funds. How can I assist you today?";
            addMessage('bot', welcomeMessage);
            conversationHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
        }


        // Function to call the Gemini API
        async function getAIResponse(userQuery) {
            if (!geminiApiKey) {
                return "API Key not found. Please refresh and enter your API key.";
            }

            // **MODIFIED**: Use the user-provided API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            // Combine system prompt, knowledge base, history, and new query
            const fullPrompt = `${knowledgeBase}\n\nConversation History:\n${conversationHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}\n\nuser: ${userQuery}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    return `API request failed: ${errorData.error.message}. Please check your API key and network connection.`;
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "I encountered an issue processing your request. Please try again.";
                }

            } catch (error) {
                console.error('Error fetching AI response:', error);
                return "I'm having trouble connecting to my knowledge base right now. Please check your connection or try again later.";
            }
        }

        // Function to add a message to the chat window
        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex items-start gap-3 my-4 ${sender === 'user' ? 'justify-end' : ''}`;
            
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const formattedMessage = sanitizedMessage.replace(/\n/g, '<br>');


            let bubbleContent = '';
            if (sender === 'bot') {
                bubbleContent = `
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-200 flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div class="chat-bubble-bot p-4 rounded-lg max-w-lg">
                        ${formattedMessage}
                    </div>
                `;
            } else {
                 bubbleContent = `
                    <div class="chat-bubble-user p-4 rounded-lg max-w-lg">
                        ${formattedMessage}
                    </div>
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-500 text-white flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                 `;
            }

            messageElement.innerHTML = bubbleContent;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Handle Chat Form Submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (userInput === '') return;

            addMessage('user', userInput);
            chatInput.value = '';
            loadingIndicator.classList.remove('hidden');

            conversationHistory.push({ role: "user", parts: [{ text: userInput }] });

            const aiResponse = await getAIResponse(userInput);

            conversationHistory.push({ role: "model", parts: [{ text: aiResponse }] });
            
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }

            loadingIndicator.classList.add('hidden');
            addMessage('bot', aiResponse);
        });
        
        // Handle API Key Form Submission
        apiKeyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = apiKeyInput.value.trim();
            if (key) {
                geminiApiKey = key;
                sessionStorage.setItem('geminiApiKey', key);
                startChat();
            }
        });

        // Initializer
        window.onload = () => {
            if (geminiApiKey) {
                startChat();
            } else {
                chatContainer.classList.add('hidden');
                apiKeySection.classList.remove('hidden');
            }
        };

    </script>
</body>
</html>

